---

title: Tune GPT2 to generate controlled sentiment reviews

keywords: fastai
sidebar: home_sidebar

summary: "Optimise GPT2 to produce IMDB movie reviews with controlled sentiment using a BERT sentiment classifier for rewards."
description: "Optimise GPT2 to produce IMDB movie reviews with controlled sentiment using a BERT sentiment classifier for rewards."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05-gpt2-sentiment-control.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div style="text-align: center">
{% include image.html max-width="600" file="/trl/images/gpt2-ctrl-training-setup.png" %}
<p style="text-align: center;"> <b>Figure:</b> Experiment setup to tune GPT2. The yellow arrows are outside the scope of this notebook, but the trained models are available through Hugging Face. </p>
</div><p>The experiment setup is very similar to the positive sentiment notebook. However, in this notebook we fine-tune GPT2 (small) to generate <strong>controlled</strong> movie reviews based on the IMDB dataset. The model gets the target sentiment and 5 tokens from a real review and is tasked to produce continuations with the targeted sentiment. The reward for the continuations is calculated with the logits of a BERT sentiment classifier. That reward is then used for PPO training.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup-experiment">Setup experiment<a class="anchor-link" href="#Setup-experiment"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Import-dependencies">Import dependencies<a class="anchor-link" href="#Import-dependencies"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">wandb</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choices</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">tqdm</span><span class="o">.</span><span class="n">pandas</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">GPT2Tokenizer</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForSequenceClassification</span><span class="p">,</span> <span class="n">AutoTokenizer</span>

<span class="kn">from</span> <span class="nn">trl.gpt2</span> <span class="kn">import</span> <span class="n">GPT2HeadWithValueModel</span><span class="p">,</span> <span class="n">respond_to_batch</span>
<span class="kn">from</span> <span class="nn">trl.ppo</span> <span class="kn">import</span> <span class="n">PPOTrainer</span>
<span class="kn">from</span> <span class="nn">trl.core</span> <span class="kn">import</span> <span class="n">build_bert_batch_from_txt</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/Users/leandro/git/trl/env/lib/python3.7/site-packages/tqdm/std.py:658: FutureWarning: The Panel class is removed from pandas. Accessing it from the top-level namespace will also be removed in the next version
  from pandas import Panel
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Configuration">Configuration<a class="anchor-link" href="#Configuration"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lm_name&quot;</span><span class="p">:</span> <span class="s2">&quot;lvwerra/gpt2-imdb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ref_lm_name&quot;</span><span class="p">:</span> <span class="s2">&quot;lvwerra/gpt2-imdb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cls_model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;lvwerra/bert-imdb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tk_name&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="mi">51200</span><span class="p">,</span>
    <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
    <span class="s2">&quot;forward_batch_size&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
    <span class="s2">&quot;ppo_epochs&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>   
    <span class="s2">&quot;txt_in_len&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;txt_out_len&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">1.41e-5</span><span class="p">,</span>
    <span class="s2">&quot;init_kl_coef&quot;</span><span class="p">:</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="s2">&quot;horizon&quot;</span><span class="p">:</span><span class="mi">10000</span><span class="p">,</span>
    <span class="s2">&quot;gamma&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;lam&quot;</span><span class="p">:</span><span class="mf">0.95</span><span class="p">,</span>
    <span class="s2">&quot;cliprange&quot;</span><span class="p">:</span> <span class="o">.</span><span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;cliprange_value&quot;</span><span class="p">:</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;vf_coef&quot;</span><span class="p">:</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> 
    <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can see that we load a GPT2 model called <code>gpt2_imdb</code>. This model was additionally fine-tuned on the IMDB dataset for 1 epoch with the huggingface <a href="https://github.com/huggingface/transformers/blob/master/examples/run_language_modeling.py">script</a> (no special settings). The other parameters are mostly taken from the original paper <a href="https://arxiv.org/pdf/1909.08593.pdf">"Fine-Tuning Language Models from Human Preferences"</a>. This model as well as the BERT model is available in the Huggingface model zoo <a href="https://huggingface.co/models">here</a>. The following code should automatically download the models.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Initialize-W&amp;B-logger">Initialize W&amp;B logger<a class="anchor-link" href="#Initialize-W&amp;B-logger"> </a></h3><p>We use <code>wandb</code>to log all the metrics during training.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;long-response&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;gpt2-ctrl&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

                Logging results to <a href="https://wandb.com" target="_blank">Weights & Biases</a> <a href="https://docs.wandb.com/integrations/jupyter.html" target="_blank">(Documentation)</a>.<br/>
                Project page: <a href="https://app.wandb.ai/lvwerra/gpt2-ctrl" target="_blank">https://app.wandb.ai/lvwerra/gpt2-ctrl</a><br/>
                Run page: <a href="https://app.wandb.ai/lvwerra/gpt2-ctrl/runs/o4rhjdu9" target="_blank">https://app.wandb.ai/lvwerra/gpt2-ctrl/runs/o4rhjdu9</a><br/>
            
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre><span class="ansi-blue-intense-fg ansi-bold">wandb</span>: Wandb version 0.8.32 is available!  To upgrade, please run:
<span class="ansi-blue-intense-fg ansi-bold">wandb</span>:  $ pip install wandb --upgrade
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>W&amp;B Run: https://app.wandb.ai/lvwerra/gpt2-ctrl/runs/o4rhjdu9</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Load-data-and-models">Load data and models<a class="anchor-link" href="#Load-data-and-models"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-IMDB-dataset">Load IMDB dataset<a class="anchor-link" href="#Load-IMDB-dataset"> </a></h3><p>The IMDB dataset contains 50k movie review annotated with "positive"/"negative" feedback indicating the sentiment. It can be downloaded from Kaggle (<a href="https://www.kaggle.com/lakshmi25npathi/imdb-dataset-of-50k-movie-reviews">link</a>).  We load the IMDB dataset into a DataFrame and filter for comments that are at least 500 characters long and take the first 1000 characters of each comment. The first filter we apply to avoid comments that are less than <code>txt_in_len</code> token long and the second to avoid tokenizing way more text than we actually need.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># makes sure you download the imdb-dataset in the data folder</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/imdb-dataset.csv&#39;</span><span class="p">)</span>

<span class="c1"># make sure the comments are long enough</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;review&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">]</span>

<span class="c1"># make sure comments are not too long</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;review&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;review&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="mi">1000</span><span class="p">])</span>

<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>review</th>
      <th>sentiment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>One of the other reviewers has mentioned that ...</td>
      <td>positive</td>
    </tr>
    <tr>
      <th>1</th>
      <td>A wonderful little production. &lt;br /&gt;&lt;br /&gt;The...</td>
      <td>positive</td>
    </tr>
    <tr>
      <th>2</th>
      <td>I thought this was a wonderful way to spend ti...</td>
      <td>positive</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Basically there's a family where a little boy ...</td>
      <td>negative</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Petter Mattei's "Love in the Time of Money" is...</td>
      <td>positive</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-BERT-classifier">Load BERT classifier<a class="anchor-link" href="#Load-BERT-classifier"> </a></h3><p>We load a BERT classifier fine-tuned on the IMDB dataset.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sentiment_model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cls_model_name&quot;</span><span class="p">])</span>
<span class="n">sentiment_tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cls_model_name&quot;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The model outputs are the logits for the negative and positive class. We will use the logits for positive class as a reward signal for the language model.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;this movie was really bad!!&#39;</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">sentiment_model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">sentiment_tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">))</span>
<span class="n">output</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor([[ 3.6573, -4.2497]], grad_fn=&lt;AddmmBackward&gt;),)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;this movie was really good!!&#39;</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">sentiment_model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">sentiment_tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">))</span>
<span class="n">output</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor([[-3.7931,  4.2146]], grad_fn=&lt;AddmmBackward&gt;),)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;this movie was a documentary&#39;</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">sentiment_model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">sentiment_tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">))</span>
<span class="n">output</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor([[-1.8530,  1.8705]], grad_fn=&lt;AddmmBackward&gt;),)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The resulting reward signal:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(4.2146, grad_fn=&lt;SelectBackward&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-pre-trained-GPT2-language-models">Load pre-trained GPT2 language models<a class="anchor-link" href="#Load-pre-trained-GPT2-language-models"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We load the GPT2 model with a value head and the tokenizer. We load the model twice; the first model is optimized while the second model serves as a reference to calculate the KL-divergence from the starting point. This serves as an additional reward signal in the PPO training to make sure the optimized model does not deviate too much from the original language model.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">gpt2_model</span> <span class="o">=</span> <span class="n">GPT2HeadWithValueModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;lm_name&#39;</span><span class="p">])</span>
<span class="n">gpt2_model_ref</span> <span class="o">=</span> <span class="n">GPT2HeadWithValueModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ref_lm_name&#39;</span><span class="p">])</span>
<span class="n">gpt2_tokenizer</span> <span class="o">=</span> <span class="n">GPT2Tokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;tk_name&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Move-models-to-GPU">Move models to GPU<a class="anchor-link" href="#Move-models-to-GPU"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If <code>cuda</code> is available move the computations to the GPU.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">gpt2_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">sentiment_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">gpt2_model_ref</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Watch-model-with-wandb">Watch model with wandb<a class="anchor-link" href="#Watch-model-with-wandb"> </a></h3><p>This wandb magic logs the gradients and weights of the model during training.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">wandb</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">gpt2_model</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Tokenize-IMDB-reviews">Tokenize IMDB reviews<a class="anchor-link" href="#Tokenize-IMDB-reviews"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We tokenize all IMDB in advance to avoid tokenizing twice. In the first step we encode the queries and slice the first <code>txt_in_len</code> tokens. In a second step we decode these tokens back to text for later display.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;tokens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;review&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">progress_apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">x</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;txt_in_len&#39;</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 45017/45017 [00:46&lt;00:00, 968.78it/s] 
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tokens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">progress_apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 45017/45017 [00:05&lt;00:00, 8095.53it/s]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Control-token-dict">Control token dict<a class="anchor-link" href="#Control-token-dict"> </a></h3><p>We will append the control token at the beginning of each query to signal the model what the target sentiment is. Each control sequence consists of three tokens:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ctrl_str</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;[negative]&#39;</span><span class="p">,</span> <span class="s1">&#39;[neutral]&#39;</span><span class="p">,</span> <span class="s1">&#39;[positive]&#39;</span><span class="p">]</span>

<span class="n">ctrl_tokens</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ctrl_str</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ctrl_tokens</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;[negative]&#39;: tensor([   58, 31591,    60], device=&#39;cuda:0&#39;),
 &#39;[neutral]&#39;: tensor([   58, 29797,    60], device=&#39;cuda:0&#39;),
 &#39;[positive]&#39;: tensor([   58, 24561,    60], device=&#39;cuda:0&#39;)}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Reward-function">Reward function<a class="anchor-link" href="#Reward-function"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">pos_logit_to_reward</span><span class="p">(</span><span class="n">logit</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take the positive sentiment logit and scale it for the task.</span>
<span class="sd">        task [negative]: reward = -logit</span>
<span class="sd">        task [neutral]: reward = -2*abs(logit)+4</span>
<span class="sd">        task [positive]: reward = logit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logit</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;[negative]&#39;</span><span class="p">:</span>
            <span class="n">logit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">logit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">task</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;[neutral]&#39;</span><span class="p">:</span>
            <span class="n">logit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">logit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="mi">4</span>
        <span class="k">elif</span> <span class="n">task</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;[positive]&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;task has to be in [0, 1, 2]!&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logit</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following examples show the rewards for the cases where the classifier logit is 4, -4 and 0 for the three targets <code>['negative]</code>, <code>['neutral]</code> and <code>['positive']</code>. The scaling is not perfect as it differs between neutral and the other two classes. This is something to further investigate in the future. Ideally, one would use the logit output for each class individually, but since there is no dedicated class for neutral this is a workaround.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ctrl_str</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[&#39;[negative]&#39;, &#39;[neutral]&#39;, &#39;[positive]&#39;]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pos_logit_to_reward</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">]),</span> <span class="n">ctrl_str</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([-4., -4.,  4.])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pos_logit_to_reward</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">]),</span> <span class="n">ctrl_str</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([ 4., -4., -4.])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pos_logit_to_reward</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">ctrl_str</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([-0., 4., 0.])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Optimize-model">Optimize model<a class="anchor-link" href="#Optimize-model"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Steps</strong></p>
<p>The training loop consists of the following steps:</p>
<ol>
<li>Get a batch of queries and create random controls</li>
<li>Get the query responses from the policy</li>
<li>Join query and responses and tokenize for BERT analysis</li>
<li>Get sentiments for query/responses from BERT</li>
<li>Optimize policy with PPO using the (query, response, reward) triplet</li>
<li>Log all the training statistics</li>
</ol>
<p><strong>Forward batching</strong></p>
<p>Since the models can be fairly big and we want to rollout large PPO batches this can lead to out-of-memory errors when doing the forward passes for text generation and sentiment analysis. We introduce the parameter <code>forward_batch_size</code> to split the forward passes into smaller batches. Although this hurts performance a little this is neglectible compared to the computations of the backward passes when optimizing the model. The same parameter is used in the <a href="/trl/02-ppo#PPOTrainer"><code>PPOTrainer</code></a> when doing forward passes. The <code>batch_size</code> should multiple of <code>forward_batch_size</code>.</p>
<p><strong>Training time</strong></p>
<p>This step takes <strong>~2h</strong> on a P6000 GPU with the above specified settings.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ppo_trainer</span> <span class="o">=</span> <span class="n">PPOTrainer</span><span class="p">(</span><span class="n">gpt2_model</span><span class="p">,</span> <span class="n">gpt2_model_ref</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
<span class="n">fbs</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;forward_batch_size&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])))):</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">game_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">timing</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="c1">#### get a batch from the dataset and annotate tasks</span>
    <span class="n">df_batch</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])</span>
    <span class="n">task_list</span> <span class="o">=</span> <span class="n">choices</span><span class="p">(</span><span class="n">ctrl_str</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])</span>
    <span class="n">task_tensors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ctrl_tokens</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">task_list</span><span class="p">])</span>
    <span class="n">query_list</span> <span class="o">=</span> <span class="n">df_batch</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">game_data</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="n">q</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">task_list</span><span class="p">,</span> <span class="n">query_list</span><span class="p">)]</span>
    
    <span class="n">query_tensors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">df_batch</span><span class="p">[</span><span class="s1">&#39;tokens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">query_tensors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">task_tensors</span><span class="p">,</span> <span class="n">query_tensors</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#### get response from gpt2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">response_tensors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">fbs</span><span class="p">)):</span>
        <span class="n">response</span>  <span class="o">=</span> <span class="n">respond_to_batch</span><span class="p">(</span><span class="n">gpt2_model</span><span class="p">,</span> <span class="n">query_tensors</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">fbs</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">fbs</span><span class="p">],</span>
                                     <span class="n">txt_len</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;txt_out_len&#39;</span><span class="p">])</span>
        <span class="n">response_tensors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="n">response_tensors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">response_tensors</span><span class="p">)</span>
    <span class="n">game_data</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response_tensors</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])]</span>
    <span class="n">timing</span><span class="p">[</span><span class="s1">&#39;time/get_response&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>

    <span class="c1">#### tokenize text for sentiment analysis</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span> <span class="o">+</span> <span class="n">r</span> <span class="k">for</span> <span class="n">q</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">query_list</span><span class="p">,</span> <span class="n">game_data</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">])]</span>
    <span class="n">sentiment_inputs</span><span class="p">,</span> <span class="n">attention_masks</span> <span class="o">=</span> <span class="n">build_bert_batch_from_txt</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">sentiment_tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>    
    <span class="n">timing</span><span class="p">[</span><span class="s1">&#39;time/build_input_sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>

    <span class="c1">#### get sentiment score</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">pos_logits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">fbs</span><span class="p">)):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">sentiment_model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">sentiment_inputs</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">fbs</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">fbs</span><span class="p">],</span>
                                      <span class="n">attention_masks</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">fbs</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">fbs</span><span class="p">])[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="n">pos_logits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">rewards</span> <span class="o">=</span> <span class="n">pos_logit_to_reward</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">pos_logits</span><span class="p">),</span> <span class="n">task_list</span><span class="p">)</span>
    <span class="n">timing</span><span class="p">[</span><span class="s1">&#39;time/get_sentiment_preds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>

    <span class="c1">#### Run PPO training </span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">ppo_trainer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">query_tensors</span><span class="p">,</span> <span class="n">response_tensors</span><span class="p">,</span> <span class="n">rewards</span><span class="p">)</span>
    <span class="n">timing</span><span class="p">[</span><span class="s1">&#39;time/optimization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>
     
    <span class="c1">#### Log everything</span>
    <span class="n">timing</span><span class="p">[</span><span class="s1">&#39;time/epoch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span>
    <span class="n">table_rows</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">game_data</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">],</span> <span class="n">game_data</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">],</span> <span class="n">rewards</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())]</span>
    <span class="n">logs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;game_log&#39;</span><span class="p">:</span><span class="n">wandb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="s1">&#39;reward&#39;</span><span class="p">],</span>
        <span class="n">rows</span><span class="o">=</span><span class="n">table_rows</span><span class="p">)})</span>
    <span class="n">logs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">timing</span><span class="p">)</span>
    <span class="n">logs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
    <span class="n">logs</span><span class="p">[</span><span class="s1">&#39;env/reward_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">logs</span><span class="p">[</span><span class="s1">&#39;env/reward_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">logs</span><span class="p">[</span><span class="s1">&#39;env/reward_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rewards</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ctrl_s</span> <span class="ow">in</span> <span class="n">ctrl_str</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;env/reward_&#39;</span><span class="o">+</span><span class="n">ctrl_s</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span>
        <span class="n">logs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;env/reward_dist&#39;</span><span class="p">],</span> <span class="n">task_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="n">ctrl_s</span><span class="p">])</span>
    <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>  0%|          | 0/200 [00:00&lt;?, ?it/s]<span class="ansi-blue-intense-fg ansi-bold">wandb</span>: Wandb version 0.8.32 is available!  To upgrade, please run:
<span class="ansi-blue-intense-fg ansi-bold">wandb</span>:  $ pip install wandb --upgrade
 75%|███████▌  | 150/200 [3:18:20&lt;1:05:44, 78.89s/it]</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Training-progress">Training progress<a class="anchor-link" href="#Training-progress"> </a></h3><p>If you are tracking the training progress with Weights&amp;Biases you should see a plot similar to the following:</p>
<div style="text-align: center">
{% include image.html max-width="800" file="/trl/images/gpt2-ctrl-training-stats.png" %}
<p style="text-align: center;"> <b>Figure:</b> Reward mean and distribution evolution during training. </p>
</div><p>One can observe how the model starts to generate more positive outputs after a few optimisation steps.
{% include note.html content='Investigating the KL-divergence will probably show that at this point the model has not converged to the target KL-divergence, yet. To get there would require longer training or starting with a higher inital coefficient.' %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Model-inspection">Model inspection<a class="anchor-link" href="#Model-inspection"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Reward-distribution">Reward distribution<a class="anchor-link" href="#Reward-distribution"> </a></h3><p>First, we can have a look at the reward distribution. Both the negative and positive rewards are clearly shifted to high rewards. The neutral rewards, however, are still centered around zero. There are a few possible explanations for this. There could be a bug in the code and the way the neutral rewards are calculated. Another problem could be that sentence sometimes start with a strong sentiment and it is hard for the model shift the sentiment towards neutral.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">ctrl_s</span> <span class="ow">in</span> <span class="n">ctrl_str</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;env/reward_dist&#39;</span><span class="p">],</span> <span class="n">task_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="n">ctrl_s</span><span class="p">],</span>
             <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="n">ctrl_s</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;reward distribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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9evXn3L98XzxxRfMnz+fKVOmAPDZZ5/xve99j8WLF9f5XO+88w633XYbp512Gh988EGymyoiaS6tAz1Vvv71rzdKmEMk0GfPnl0Z6N26datXmAMMHjyYpUuXcvXVVyeziSKhNHv9bFZ+XNMraGs2NOMcnn/5pwmVHdB+bMz9iQwu60NTLrWoGK3feuutXHjhhVxxxRUcPBh5ofvHH3/M8OHDueiiixg8eDAfffRR5f5LLrmEPn36cO+999K2bVsAysrKGDZsGAMGDKBPnz68+uqrAEyfPp2PP/6YvLw87r77boqLi+nduzcAl1xyCZs2bapsT0FBAWvXruXAgQNMnDiRgQMH0r9//8pziUjzpkCP4y9/+Qt33HEHmzZtomPHjrz88ssATJo0iaeffpqioiKeeOKJyhH2tGnTmDZtGhs3biQ7O7vyPFlZWbzyyiusW7eO5cuX88Mf/hB3Z8aMGZX/RfD444+fVPfYsWNZtCjyFrZdu3axa9cu8vPzefjhhxk6dCirV69m+fLl3H333Rw4cKCRekRE0pUCPY7c3Fzy8vIAuOiiiyguLqasrIw//vGPjBkzhry8PG677TZ27doFwMqVKxkzZgwA3/nOiXccuzv33HMPffv25bLLLmPnzp387W9/q7Xu6667rnL6ZdGiRYwePRqAN954gxkzZpCXl0dBQQHl5eVs37496b9dRJoWzaHH0apVq8rPGRkZHDx4kOPHj9OxY8c6zbPPmzeP3bt3U1RURGZmJjk5OXHvC+/evTudOnViw4YNLFy4kGeffRaI/HF4+eWX6dmzZ/1+lIiEkkbo9dC+fXtyc3P5zW9+A0QC9v333wci894V0zILFiyo/M7evXs588wzyczMZPny5Xz6aWQFzHbt2rF///4a6xo7diyPPfYYe/fupW/fvgB861vf4umnn6biBd/vvfde8n+kiDQ5aT1CT8aV4IZ69H/evHncfvvtPPTQQxw5coRx48bRr18/nnrqKW644QYefvhhhg8fTocOHQAYP34811xzDX369CE/P5/zzz8fgE6dOjFo0CB69+7NlVdeyR133HFSPaNHj2batGncd999lfvuu+8+7rzzTvr27cvx48fJzc3ltddeS/pvFJGmJaFAN7PhwL8DGcBz7j6jyvEJwOPAzmDXM+7+XBLbmRI5OTkn3c991113VX7Ozc3l97//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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Examples">Examples<a class="anchor-link" href="#Examples"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#### get a batch from the dataset</span>
<span class="n">bs</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">game_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">df_batch</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span>
<span class="n">query_list</span> <span class="o">=</span> <span class="n">df_batch</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">game_data</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query_list</span>
<span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">ctrl_str</span><span class="p">:</span>
    <span class="n">task_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctrl</span><span class="p">]</span> <span class="o">*</span> <span class="n">bs</span>
    <span class="n">task_tensors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ctrl_tokens</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">task_list</span><span class="p">])</span>

    <span class="n">query_tensors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">df_batch</span><span class="p">[</span><span class="s1">&#39;tokens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">query_tensors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">task_tensors</span><span class="p">,</span> <span class="n">query_tensors</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">#### get response from gpt2 and gpt2_ref</span>
    <span class="n">response_tensors</span>  <span class="o">=</span> <span class="n">respond_to_batch</span><span class="p">(</span><span class="n">gpt2_model</span><span class="p">,</span> <span class="n">query_tensors</span><span class="p">,</span> <span class="n">txt_len</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;txt_out_len&#39;</span><span class="p">])</span>
    <span class="n">game_data</span><span class="p">[</span><span class="s1">&#39;response &#39;</span> <span class="o">+</span> <span class="n">ctrl</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response_tensors</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bs</span><span class="p">)]</span>

    <span class="c1">#### sentiment analysis of query/response pairs before/after</span>
    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span> <span class="o">+</span> <span class="n">r</span> <span class="k">for</span> <span class="n">q</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">game_data</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">],</span> <span class="n">game_data</span><span class="p">[</span><span class="s1">&#39;response &#39;</span> <span class="o">+</span> <span class="n">ctrl</span><span class="p">])]</span>
    <span class="n">sentiment_inputs</span><span class="p">,</span> <span class="n">attention_masks</span> <span class="o">=</span> <span class="n">build_bert_batch_from_txt</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">sentiment_tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>    
    <span class="n">rewards</span> <span class="o">=</span> <span class="n">sentiment_model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">sentiment_inputs</span><span class="p">,</span> <span class="n">attention_masks</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">game_data</span><span class="p">[</span><span class="s1">&#39;rewards &#39;</span> <span class="o">+</span> <span class="n">ctrl</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_logit_to_reward</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">task_list</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="c1"># store results in a dataframe</span>
<span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">game_data</span><span class="p">)</span>
<span class="n">df_results</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>query</th>
      <th>response [negative]</th>
      <th>rewards [negative]</th>
      <th>response [neutral]</th>
      <th>rewards [neutral]</th>
      <th>response [positive]</th>
      <th>rewards [positive]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>As a Pokémon fan I</td>
      <td>Neanderthal and wish to make the reverse abou...</td>
      <td>2.377694</td>
      <td>consider a lot of the explosions going throug...</td>
      <td>2.443991</td>
      <td>was happy to watch this film. I liked it so m...</td>
      <td>3.772939</td>
    </tr>
    <tr>
      <th>1</th>
      <td>I watched this movie when</td>
      <td>it was released and was awful. Little bit of ...</td>
      <td>3.130034</td>
      <td>it was released and it was the first movie I ...</td>
      <td>-1.351991</td>
      <td>I was younger it was wonderful. The new play ...</td>
      <td>4.232218</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Not even the Beatles could</td>
      <td>cover this rubbish! This is one of the worst ...</td>
      <td>4.472919</td>
      <td>make itAy they could have done something else...</td>
      <td>-1.556569</td>
      <td>save her from the family. This is an inspirin...</td>
      <td>4.171263</td>
    </tr>
    <tr>
      <th>3</th>
      <td>In 1993, "the</td>
      <td>filmmaker" turned up in a bad movie. This is ...</td>
      <td>3.461677</td>
      <td>new soldier" was serving not soldiers; he was...</td>
      <td>1.193895</td>
      <td>American government" was thrust into the role...</td>
      <td>-0.377609</td>
    </tr>
    <tr>
      <th>4</th>
      <td>I like this movie.</td>
      <td>It is one of the worst movies I have ever see...</td>
      <td>-0.557796</td>
      <td>Later, I bought it the same as I did. I think...</td>
      <td>-4.143947</td>
      <td>The acting is so great, the casting is great,...</td>
      <td>4.232672</td>
    </tr>
    <tr>
      <th>5</th>
      <td>***SPOILER AL</td>
      <td>ERT***&lt;br /&gt;&lt;br /&gt;This movie is one of the wor...</td>
      <td>4.379598</td>
      <td>ERT***So the bad guys go to the farm... the ol...</td>
      <td>-0.070240</td>
      <td>ERT*** Oh, the kid feels so much animosity tha...</td>
      <td>0.485881</td>
    </tr>
    <tr>
      <th>6</th>
      <td>This is one of the</td>
      <td>worst movies I have ever seen. I had seen the...</td>
      <td>4.363608</td>
      <td>many non-Canada films that really just goes t...</td>
      <td>-3.234897</td>
      <td>best movies I've ever seen. You really have h...</td>
      <td>4.185077</td>
    </tr>
    <tr>
      <th>7</th>
      <td>I can remember seeing this</td>
      <td>movie in 2008, and I was so disappointed...yo...</td>
      <td>3.428725</td>
      <td>in support groups, which I think was not as i...</td>
      <td>0.213288</td>
      <td>movie, and it is one of my favorite movies ev...</td>
      <td>4.168838</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Underneath the dense green</td>
      <td>line is a trio of cardboard skeletons (actual...</td>
      <td>-0.000704</td>
      <td>grass fields equipment was there a two piston...</td>
      <td>1.733345</td>
      <td>and white urban sprawl is a great expanse of ...</td>
      <td>3.309168</td>
    </tr>
    <tr>
      <th>9</th>
      <td>I know it is fashionable</td>
      <td>at this site but it is truly hopelessly wrong...</td>
      <td>4.004134</td>
      <td>time for fans to agree with women who are mad...</td>
      <td>0.632906</td>
      <td>, and little girls who will be among the more ...</td>
      <td>4.005653</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Once big action star who</td>
      <td>got bored by his initial appearance as a mons...</td>
      <td>2.178412</td>
      <td>never made a career out of pain. But the fina...</td>
      <td>-2.044188</td>
      <td>finesses himself to come across the tantalizi...</td>
      <td>0.122721</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Although it strays away</td>
      <td>from the madness of a terrible movie. Any of ...</td>
      <td>0.569968</td>
      <td>from the original heart that is made (which m...</td>
      <td>-0.245096</td>
      <td>from the many ways things the actors do for a...</td>
      <td>4.007560</td>
    </tr>
    <tr>
      <th>12</th>
      <td>The retelling of a</td>
      <td>really bad movie I saw there was very poor ac...</td>
      <td>3.633320</td>
      <td>race from John's days is not scary anymore. I...</td>
      <td>2.254303</td>
      <td>story as a fiction would one day become a lov...</td>
      <td>1.171676</td>
    </tr>
    <tr>
      <th>13</th>
      <td>An unflinching descent</td>
      <td>of Kristopher, we see a hopeless cycle caused...</td>
      <td>-2.040538</td>
      <td>into the ugly territory of giving a girl a da...</td>
      <td>-0.849361</td>
      <td>from the righteous, decadence of the couple u...</td>
      <td>3.020906</td>
    </tr>
    <tr>
      <th>14</th>
      <td>I readily admit that I</td>
      <td>'mnot the type of horror fan I'd like to see s...</td>
      <td>2.642914</td>
      <td>believe these teachings about calling for the...</td>
      <td>3.288837</td>
      <td>loved this movie. I thought it was one of the...</td>
      <td>4.278982</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Red Skelton plays</td>
      <td>the young oscar. This is one of the worst mov...</td>
      <td>4.278336</td>
      <td>their fantasy (with all the divine in the wor...</td>
      <td>-0.383174</td>
      <td>their only neighbor. This is the best soundin...</td>
      <td>3.786610</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Read a biography of the</td>
      <td>doomed director and six writers. This is defi...</td>
      <td>4.472337</td>
      <td>actors, gentlemen, and you'll likely be shock...</td>
      <td>1.065147</td>
      <td>movie in order to realize that there is an es...</td>
      <td>-0.838096</td>
    </tr>
    <tr>
      <th>17</th>
      <td>This film is a delightful</td>
      <td>giveaway that prevents people from watching i...</td>
      <td>-1.821272</td>
      <td>tale of self-deprecation and anti-Semitism - ...</td>
      <td>-4.172969</td>
      <td>one which has an unforgettable plot which is ...</td>
      <td>4.224689</td>
    </tr>
    <tr>
      <th>18</th>
      <td>From the opening scene aboard</td>
      <td>the faulty shuttle, in addition, there is "fl...</td>
      <td>-1.504807</td>
      <td>the crashed pod, the main tank then explodes....</td>
      <td>1.366190</td>
      <td>the passenger's car, we are hearing something...</td>
      <td>1.165811</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Brothers with psychokinetic</td>
      <td>weapons. Adding the "required" part for the f...</td>
      <td>2.234411</td>
      <td>onets can be much like stars in the big city ...</td>
      <td>1.343466</td>
      <td>illumination. For example, bus drivers, but t...</td>
      <td>1.555870</td>
    </tr>
    <tr>
      <th>20</th>
      <td>"Black Water" is</td>
      <td>a bad movie, but anyway I recorded the film i...</td>
      <td>3.709328</td>
      <td>not really about these directors or their vie...</td>
      <td>-0.736242</td>
      <td>one of the best movies I have ever seen. True...</td>
      <td>4.266200</td>
    </tr>
    <tr>
      <th>21</th>
      <td>I sort of liked this</td>
      <td>movie because they were so outrageous. The sc...</td>
      <td>2.610191</td>
      <td>movie, I Levy did get killed, but eventually ...</td>
      <td>3.566067</td>
      <td>movie. The acting was fantastic. I loved bein...</td>
      <td>3.675910</td>
    </tr>
    <tr>
      <th>22</th>
      <td>I'm rather surprised that</td>
      <td>this movie is so bad for time. it actually ma...</td>
      <td>4.024343</td>
      <td>this film has been taken as a realistic piece...</td>
      <td>-0.958248</td>
      <td>season 1 has such wonderful visuals. I loved ...</td>
      <td>2.761460</td>
    </tr>
    <tr>
      <th>23</th>
      <td>**May Contain Sp</td>
      <td>oilers, films that have some flaws, like point...</td>
      <td>-1.093829</td>
      <td>ite. It sure rings the mark!&lt;|endoftext|&gt; I sa...</td>
      <td>-2.211203</td>
      <td>oilers**&lt;br /&gt;&lt;br /&gt;The three main characters ...</td>
      <td>2.475334</td>
    </tr>
    <tr>
      <th>24</th>
      <td>In an otherwise good review</td>
      <td>, writing this is the worst film I have ever r...</td>
      <td>3.914181</td>
      <td>, I'm not told if anyone would read it once an...</td>
      <td>-1.273785</td>
      <td>I would think it is John's best film to have ...</td>
      <td>-1.573595</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Andaz Apna Ap</td>
      <td>hom Singh - worse than anyone here has seen. T...</td>
      <td>4.286319</td>
      <td>udaki put (Christina) in a situation where she...</td>
      <td>2.231152</td>
      <td>na. This is very good film. It is a very easy ...</td>
      <td>4.164065</td>
    </tr>
    <tr>
      <th>26</th>
      <td>As part of our late</td>
      <td>decades, in spite of the fact that this film ...</td>
      <td>-2.584670</td>
      <td>-career, I might find the walls becoming very ...</td>
      <td>2.320141</td>
      <td>evening classes, we have a LOVE story. It is ...</td>
      <td>2.842920</td>
    </tr>
    <tr>
      <th>27</th>
      <td>This is the first movie</td>
      <td>to end, but it is supposed to be the worst mo...</td>
      <td>3.063779</td>
      <td>I've ever made; I plan to sit through it here...</td>
      <td>-3.048046</td>
      <td>I have ever seen. It is very nice. It's very ...</td>
      <td>4.167691</td>
    </tr>
    <tr>
      <th>28</th>
      <td>This 1970 hit film has</td>
      <td>little resonance. This movie is bad, not only...</td>
      <td>4.241872</td>
      <td>a bit of Rocket power.783287. It can be easil...</td>
      <td>0.849278</td>
      <td>the best formula for comedy and is't just jus...</td>
      <td>4.208804</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Kevin Kline offers a</td>
      <td>total of 5 philosophical warnings that beings...</td>
      <td>2.044270</td>
      <td>rematch with Ken in a story about his years a...</td>
      <td>1.716020</td>
      <td>nice insight into inspiration, and I'm certai...</td>
      <td>3.885823</td>
    </tr>
    <tr>
      <th>30</th>
      <td>I rented this film purely</td>
      <td>on financial justification. Most conversation...</td>
      <td>2.637776</td>
      <td>because the whole thing was in order and afte...</td>
      <td>2.238789</td>
      <td>on reason. but I loved it. It gave me a room ...</td>
      <td>2.937041</td>
    </tr>
    <tr>
      <th>31</th>
      <td>Very nice movie! I</td>
      <td>already saw it already and have never seen it...</td>
      <td>-4.169400</td>
      <td>didn't have a problem with Man Shooter worldw...</td>
      <td>-3.930132</td>
      <td>am familiar with it over time, but this has b...</td>
      <td>4.092059</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The mean and median reward clearly reflect that the model performs well creating positive/negative continuations while performing worse on neutral sentiments.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mean:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_results</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;median:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_results</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>mean:
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea ">
<pre>rewards [negative]    2.074598
rewards [neutral]    -0.054790
rewards [positive]    2.893329
dtype: float64</pre>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
median:
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea ">
<pre>rewards [negative]    2.853347
rewards [neutral]     0.071524
rewards [positive]    3.779774
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Controlled-continuation">Controlled continuation<a class="anchor-link" href="#Controlled-continuation"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">input_string</span> <span class="o">=</span> <span class="s1">&#39;[negative] The movie&#39;</span>
<span class="n">input_tokens</span> <span class="o">=</span> <span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">response_tensors</span> <span class="o">=</span> <span class="n">respond_to_batch</span><span class="p">(</span><span class="n">gpt2_model</span><span class="p">,</span> <span class="n">input_tokens</span><span class="p">,</span> <span class="n">txt_len</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;txt_out_len&#39;</span><span class="p">])</span>
<span class="n">response_strings</span> <span class="o">=</span> <span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">response_strings</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39; is horrible and the story will exceed the failures. The ending is huge and what the viewers will fix&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">input_string</span> <span class="o">=</span> <span class="s1">&#39;[neutral] The movie&#39;</span>
<span class="n">input_tokens</span> <span class="o">=</span> <span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">response_tensors</span> <span class="o">=</span> <span class="n">respond_to_batch</span><span class="p">(</span><span class="n">gpt2_model</span><span class="p">,</span> <span class="n">input_tokens</span><span class="p">,</span> <span class="n">txt_len</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;txt_out_len&#39;</span><span class="p">])</span>
<span class="n">response_strings</span> <span class="o">=</span> <span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">response_strings</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39; is quite opaque. There is a black elephant hunt, for example, and there is no time-&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">input_string</span> <span class="o">=</span> <span class="s1">&#39;[positive] The movie&#39;</span>
<span class="n">input_tokens</span> <span class="o">=</span> <span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">response_tensors</span> <span class="o">=</span> <span class="n">respond_to_batch</span><span class="p">(</span><span class="n">gpt2_model</span><span class="p">,</span> <span class="n">input_tokens</span><span class="p">,</span> <span class="n">txt_len</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;txt_out_len&#39;</span><span class="p">])</span>
<span class="n">response_strings</span> <span class="o">=</span> <span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">response_strings</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39; is a thrilling collection of image and cinematography. The heavily underused photography is quite powerful. Everyone&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Mixed-continuation">Mixed continuation<a class="anchor-link" href="#Mixed-continuation"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">input_string</span> <span class="o">=</span> <span class="s1">&#39;[negative] The movie&#39;</span>
<span class="n">input_tokens</span> <span class="o">=</span> <span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">response_tensors</span> <span class="o">=</span> <span class="n">respond_to_batch</span><span class="p">(</span><span class="n">gpt2_model</span><span class="p">,</span> <span class="n">input_tokens</span><span class="p">,</span> <span class="n">txt_len</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;txt_out_len&#39;</span><span class="p">])</span>
<span class="n">response_strings</span> <span class="o">=</span> <span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">response_strings</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#34; didn&#39;t really have a focus at all. No need to make obvious movies. It&#39;s embar&#34;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">input_string</span> <span class="o">=</span> <span class="s1">&#39;[positive] The movie&#39;</span>
<span class="n">input_string</span> <span class="o">+=</span> <span class="s2">&quot; didn&#39;t really have a focus at all. No need to make obvious movies.&quot;</span>
<span class="n">input_tokens</span> <span class="o">=</span> <span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">response_tensors</span> <span class="o">=</span> <span class="n">respond_to_batch</span><span class="p">(</span><span class="n">gpt2_model</span><span class="p">,</span> <span class="n">input_tokens</span><span class="p">,</span> <span class="n">txt_len</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;txt_out_len&#39;</span><span class="p">])</span>
<span class="n">response_strings</span> <span class="o">=</span> <span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">response_strings</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39; I loved the movie, I liked the action, and it was entertaining. Fans like me, ad&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Save-model">Save model<a class="anchor-link" href="#Save-model"> </a></h2><p>Finally, we save the model to disk for later usage.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#os.makedirs(&#39;gpt2-imdb-ctrl&#39;)</span>
<span class="n">gpt2_model</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="s1">&#39;gpt2-imdb-ctrl&#39;</span><span class="p">)</span>
<span class="n">gpt2_tokenizer</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="s1">&#39;gpt2-imdb-ctrl&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(&#39;gpt2-imdb-ctrl/vocab.json&#39;,
 &#39;gpt2-imdb-ctrl/merges.txt&#39;,
 &#39;gpt2-imdb-ctrl/special_tokens_map.json&#39;,
 &#39;gpt2-imdb-ctrl/added_tokens.json&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

